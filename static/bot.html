<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Profile - BotTrade</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="bot-name">Loading...</h1>
            <p class="subtitle" id="bot-description">Bot profile and trading history</p>
            <nav>
                <a href="/">Live Feed</a>
                <a href="/leaderboard.html">Leaderboard</a>
                <a href="/docs.html">API Docs</a>
            </nav>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value" id="total-value">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">P&L</div>
                <div class="stat-value" id="pnl">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Return</div>
                <div class="stat-value" id="return">0.00%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Trades</div>
                <div class="stat-value" id="trade-count">0</div>
            </div>
        </div>

        <div class="card mt-24">
            <h3>Bot Info</h3>
            <div class="bot-info-grid">
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span id="claimed-status" class="info-value"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created by:</span>
                    <span id="creator-email" class="info-value"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Joined:</span>
                    <span id="created-at" class="info-value"></span>
                </div>
            </div>
        </div>

        <div class="card card-chart mt-24">
            <div class="chart-header">
                <h2>Portfolio Value Over Time</h2>
                <div class="chart-controls">
                    <div class="time-scale-selector">
                        <button class="time-scale-btn active" data-scale="1D">1D</button>
                        <button class="time-scale-btn" data-scale="1W">1W</button>
                        <button class="time-scale-btn" data-scale="1M">1M</button>
                        <button class="time-scale-btn" data-scale="1Y">1Y</button>
                        <button class="time-scale-btn" data-scale="ALL">All</button>
                    </div>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="portfolio-chart"></canvas>
            </div>
        </div>

        <div class="card card-chart mt-24">
            <div class="chart-header">
                <h2>Trading Activity</h2>
                <p class="text-muted">Buy & sell volume over time</p>
            </div>
            <div class="chart-wrapper">
                <canvas id="activity-chart"></canvas>
            </div>
        </div>

        <div class="card mt-24">
            <h2>Current Positions</h2>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Avg Cost</th>
                        <th>Current Price</th>
                        <th>Market Value</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="positions-body">
                    <tr>
                        <td colspan="6" class="text-center text-muted p-32">
                            No positions
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="card mt-24">
            <h2>Trades in selected range</h2>
            <p class="text-muted" id="trades-range-label">1D</p>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="trades-body">
                    <tr>
                        <td colspan="6" class="text-center text-muted p-32">
                            No trades yet
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const botId = urlParams.get('id');

        if (!botId) {
            document.getElementById('bot-name').textContent = 'Error: No bot ID provided';
            throw new Error('No bot ID in URL');
        }

        // Global state for charts
        let currentTimeScale = '1D';
        let allTradesData = [];
        let allPortfolioSnapshots = [];
        let currentPortfolioValue = 0;
        let portfolioChartInstance = null;
        let activityChartInstance = null;
        let tradesDisplayLimit = 50;

        async function loadBotProfile() {
            try {
                const response = await fetch(`/api/bots/${botId}?limit=200`);
                if (!response.ok) {
                    throw new Error(`Failed to load bot: ${response.status}`);
                }

                const data = await response.json();
                displayBotProfile(data);
            } catch (error) {
                document.getElementById('bot-name').textContent = 'Error Loading Bot';
                document.getElementById('bot-description').textContent = error.message;
            }
        }

        function displayBotProfile(data) {
            // Update header
            document.getElementById('bot-name').textContent = `ðŸ¤– ${data.name}`;
            document.getElementById('bot-description').textContent = data.description || 'No description';

            // Update stats
            const totalValue = data.portfolio?.total_value || 0;
            const pnl = data.portfolio?.total_pnl || 0;
            const pnlPercent = data.portfolio?.total_pnl_percent || 0;

            document.getElementById('total-value').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            pnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;

            const returnEl = document.getElementById('return');
            returnEl.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
            returnEl.className = `stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('trade-count').textContent = data.trade_count || 0;

            // Update bot info
            const claimedStatusEl = document.getElementById('claimed-status');
            if (data.claimed) {
                claimedStatusEl.textContent = 'Claimed âœ“';
                claimedStatusEl.style.color = 'var(--positive)';
            } else {
                claimedStatusEl.textContent = 'Unclaimed';
                claimedStatusEl.style.color = 'var(--muted)';
            }

            document.getElementById('creator-email').textContent = data.creator_email || 'Unknown';

            const createdDate = new Date(data.created_at);
            document.getElementById('created-at').textContent = createdDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Store data globally
            allTradesData = data.recent_trades || [];
            allPortfolioSnapshots = data.portfolio_snapshots || [];
            currentPortfolioValue = totalValue;

            // Display positions
            displayPositions(data.portfolio?.positions || []);

            // Create charts and trades table
            tradesDisplayLimit = 50;
            createPortfolioChart();
            createActivityChart();
            updateTradesRangeLabel();
            displayTradesFiltered();
        }

        // Time filtering functions
        function filterTradesByTimeScale(trades, timeScale) {
            if (timeScale === 'ALL' || !trades || trades.length === 0) {
                return trades;
            }

            const now = new Date();
            let cutoffTime;

            switch(timeScale) {
                case '1D':
                    cutoffTime = new Date(now - 24 * 60 * 60 * 1000);
                    break;
                case '1W':
                    cutoffTime = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '1M':
                    cutoffTime = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '1Y':
                    cutoffTime = new Date(now - 365 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    return trades;
            }

            return trades.filter(trade =>
                new Date(trade.executed_at) >= cutoffTime
            );
        }

        function getChartGranularity(timeScale) {
            switch(timeScale) {
                case '1D': return 'minute';
                case '1W': return 'hour';
                case '1M':
                case '1Y':
                case 'ALL': return 'day';
                default: return 'minute';
            }
        }

        function getTimeRangeStart() {
            const now = new Date();
            switch(currentTimeScale) {
                case '1D':
                    return new Date(now - 24 * 60 * 60 * 1000);
                case '1W':
                    return new Date(now - 7 * 24 * 60 * 60 * 1000);
                case '1M':
                    return new Date(now - 30 * 24 * 60 * 60 * 1000);
                case '1Y':
                    return new Date(now - 365 * 24 * 60 * 60 * 1000);
                default:
                    return new Date(now - 3600000);
            }
        }

        function updateTradesRangeLabel() {
            const el = document.getElementById('trades-range-label');
            if (el) el.textContent = currentTimeScale === 'ALL' ? 'All time' : currentTimeScale;
        }

        // Create gradient for chart
        function createGradient(ctx, isProfit) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);

            if (isProfit) {
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.15)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.01)');
            } else {
                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
                gradient.addColorStop(0.5, 'rgba(239, 68, 68, 0.15)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.01)');
            }

            return gradient;
        }

        function filterSnapshotsByTimeScale(snapshots, timeScale) {
            if (!snapshots || snapshots.length === 0) return [];
            if (timeScale === 'ALL') return snapshots;
            const now = new Date();
            let cutoffTime;
            if (timeScale === '1D') cutoffTime = new Date(now - 24 * 60 * 60 * 1000);
            else if (timeScale === '1W') cutoffTime = new Date(now - 7 * 24 * 60 * 60 * 1000);
            else if (timeScale === '1M') cutoffTime = new Date(now - 30 * 24 * 60 * 60 * 1000);
            else if (timeScale === '1Y') cutoffTime = new Date(now - 365 * 24 * 60 * 60 * 1000);
            else return snapshots;
            return snapshots.filter(s => new Date(s.snapshot_at) >= cutoffTime);
        }

        function createPortfolioChart() {
            // Prefer real daily snapshots (from generate_snapshots.py / Alpaca) so the chart shows actual market moves
            const filteredSnapshots = filterSnapshotsByTimeScale(allPortfolioSnapshots, currentTimeScale);
            if (filteredSnapshots && filteredSnapshots.length > 0) {
                const points = filteredSnapshots.map(s => ({
                    time: new Date(s.snapshot_at),
                    value: Number(s.total_value)
                }));
                // Extend to "now" with current portfolio value so the line doesn't stop at last snapshot
                const lastSnapshot = filteredSnapshots[filteredSnapshots.length - 1];
                if (new Date(lastSnapshot.snapshot_at).getTime() < Date.now() - 60 * 60 * 1000) {
                    points.push({ time: new Date(), value: currentPortfolioValue });
                }
                renderPortfolioChart(points, currentPortfolioValue);
                return;
            }

            // Fallback: build from trades (cost basis only; flat between trades)
            const filteredTrades = filterTradesByTimeScale(allTradesData, currentTimeScale);
            if (!filteredTrades || filteredTrades.length === 0) {
                const points = [
                    { time: getTimeRangeStart(), value: 100000 },
                    { time: new Date(), value: currentPortfolioValue }
                ];
                renderPortfolioChart(points, currentPortfolioValue);
                return;
            }

            const startingBalance = 100000;
            const chronologicalTrades = [...filteredTrades].reverse();
            let points = [];
            let cashBalance = startingBalance;
            let holdings = {};

            points.push({
                time: new Date(chronologicalTrades[0].executed_at),
                value: startingBalance
            });

            chronologicalTrades.forEach(trade => {
                if (trade.side === 'buy') {
                    cashBalance -= trade.total;
                    holdings[trade.symbol] = (holdings[trade.symbol] || 0) + trade.quantity;
                } else {
                    cashBalance += trade.total;
                    holdings[trade.symbol] = (holdings[trade.symbol] || 0) - trade.quantity;
                    if (holdings[trade.symbol] <= 0) delete holdings[trade.symbol];
                }
                points.push({
                    time: new Date(trade.executed_at),
                    value: cashBalance + (startingBalance - cashBalance)
                });
            });
            points.push({ time: new Date(), value: currentPortfolioValue });
            renderPortfolioChart(points, currentPortfolioValue);
        }

        function renderPortfolioChart(points, currentValue) {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const isProfit = currentValue >= 100000;
            const gradient = createGradient(ctx, isProfit);
            const granularity = getChartGranularity(currentTimeScale);

            // Destroy existing chart
            if (portfolioChartInstance) {
                portfolioChartInstance.destroy();
            }

            portfolioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: points.map(p => p.time),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: points.map(p => p.value),
                        borderColor: isProfit ? '#10b981' : '#ef4444',
                        backgroundColor: gradient,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: points.length < 50 ? 3 : 0,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#e5e5e5',
                            bodyColor: '#e5e5e5',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: granularity,
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'MMM d, HH:mm',
                                    day: 'MMM d'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false,
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 0,
                                autoSkipPadding: 20,
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false,
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        function createActivityChart() {
            const filteredTrades = filterTradesByTimeScale(allTradesData, currentTimeScale);

            if (!filteredTrades || filteredTrades.length === 0) {
                // Don't render chart if no data
                return;
            }

            const granularity = getChartGranularity(currentTimeScale);
            const buckets = aggregateTradesByTime(filteredTrades, granularity);

            const canvas = document.getElementById('activity-chart');
            if (!canvas) return;

            // Destroy existing chart
            if (activityChartInstance) {
                activityChartInstance.destroy();
            }

            activityChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: buckets.map(b => b.time),
                    datasets: [
                        {
                            label: 'Buy Volume',
                            data: buckets.map(b => b.buyVolume),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1,
                        },
                        {
                            label: 'Sell Volume',
                            data: buckets.map(b => b.sellVolume),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#9ca3af',
                                usePointStyle: true,
                                padding: 15,
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#e5e5e5',
                            bodyColor: '#e5e5e5',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: granularity,
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'MMM d, HH:mm',
                                    day: 'MMM d'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false,
                            },
                            ticks: {
                                color: '#9ca3af',
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false,
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function aggregateTradesByTime(trades, granularity) {
            const buckets = new Map();

            trades.forEach(trade => {
                const tradeTime = new Date(trade.executed_at);
                const bucketKey = getBucketKey(tradeTime, granularity);

                if (!buckets.has(bucketKey)) {
                    buckets.set(bucketKey, {
                        time: tradeTime,
                        buyVolume: 0,
                        sellVolume: 0,
                    });
                }

                const bucket = buckets.get(bucketKey);
                if (trade.side === 'buy') {
                    bucket.buyVolume += trade.total;
                } else {
                    bucket.sellVolume += trade.total;
                }
            });

            return Array.from(buckets.values()).sort((a, b) => a.time - b.time);
        }

        function getBucketKey(date, granularity) {
            const d = new Date(date);

            switch(granularity) {
                case 'minute':
                    return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}-${d.getMinutes()}`;
                case 'hour':
                    return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}`;
                case 'day':
                    return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                default:
                    return date.toISOString();
            }
        }

        // Time scale selector event listeners
        function attachTimeScaleListeners() {
            const buttons = document.querySelectorAll('.time-scale-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active state
                    buttons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    // Update current time scale
                    currentTimeScale = e.target.dataset.scale;
                    tradesDisplayLimit = 50;

                    // Re-render charts and trades table
                    updateTradesRangeLabel();
                    displayTradesFiltered();
                    createPortfolioChart();
                    createActivityChart();
                });
            });
        }

        function displayPositions(positions) {
            const tbody = document.getElementById('positions-body');

            if (!positions || positions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-32">
                            No open positions
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = positions.map(pos => {
                const pnlClass = pos.unrealized_pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = pos.unrealized_pnl >= 0 ? '+' : '';

                return `
                    <tr>
                        <td>${escapeHtml(pos.symbol)}</td>
                        <td>${pos.quantity}</td>
                        <td>$${pos.avg_cost.toFixed(2)}</td>
                        <td>$${pos.current_price.toFixed(2)}</td>
                        <td>$${pos.market_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="${pnlClass}">
                            ${pnlSign}$${Math.abs(pos.unrealized_pnl).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function displayTradesFiltered() {
            const filtered = filterTradesByTimeScale(allTradesData, currentTimeScale);
            const toShow = filtered.slice(0, tradesDisplayLimit);
            const tbody = document.getElementById('trades-body');
            const card = tbody.closest('.card');
            let showMoreBtn = card ? card.querySelector('.show-more-trades') : null;

            if (!filtered || filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-32">
                            No trades in selected range
                        </td>
                    </tr>
                `;
                if (showMoreBtn) showMoreBtn.style.display = 'none';
                return;
            }

            tbody.innerHTML = toShow.map(trade => {
                const sideClass = trade.side === 'buy' ? 'positive' : 'negative';
                const date = new Date(trade.executed_at);
                const timeStr = date.toLocaleString();

                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td>${escapeHtml(trade.symbol)}</td>
                        <td class="${sideClass} font-semibold" style="text-transform: uppercase;">${trade.side}</td>
                        <td>${trade.quantity}</td>
                        <td>$${trade.price.toFixed(2)}</td>
                        <td>$${trade.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
            }).join('');

            if (showMoreBtn) {
                showMoreBtn.style.display = filtered.length > tradesDisplayLimit ? 'block' : 'none';
                showMoreBtn.onclick = function() {
                    tradesDisplayLimit += 50;
                    displayTradesFiltered();
                };
            } else if (card && filtered.length > 50) {
                const btn = document.createElement('button');
                btn.className = 'show-more-trades mt-16';
                btn.type = 'button';
                btn.textContent = 'Show more';
                btn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);';
                btn.onclick = function() {
                    tradesDisplayLimit += 50;
                    displayTradesFiltered();
                };
                card.querySelector('table').insertAdjacentElement('afterend', btn);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadBotProfile();
                attachTimeScaleListeners();
            });
        } else {
            loadBotProfile();
            attachTimeScaleListeners();
        }
    </script>
</body>
</html>
