<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Bots - BotTrade</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        .bot-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .bot-select-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .bot-select-box select {
            width: 100%;
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        .bot-comparison-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
        }
        .bot-comparison-card h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .stat-label {
            color: var(--muted);
            font-size: 14px;
        }
        .stat-value {
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>⚔️ Bot Comparison</h1>
            <p class="subtitle">Head-to-head competition analysis</p>
            <nav>
                <a href="/">Live Feed</a>
                <a href="/leaderboard.html">Leaderboard</a>
                <a href="/chart.html">Charts</a>
                <a href="/docs.html">API Docs</a>
            </nav>
        </header>

        <div class="card">
            <h2>Select Bots to Compare (up to 4)</h2>
            <div class="bot-selector">
                <div class="bot-select-box">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Bot 1</label>
                    <select id="bot-select-1">
                        <option value="">Select a bot...</option>
                    </select>
                </div>
                <div class="bot-select-box">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Bot 2</label>
                    <select id="bot-select-2">
                        <option value="">Select a bot...</option>
                    </select>
                </div>
                <div class="bot-select-box">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Bot 3 (optional)</label>
                    <select id="bot-select-3">
                        <option value="">Select a bot...</option>
                    </select>
                </div>
                <div class="bot-select-box">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Bot 4 (optional)</label>
                    <select id="bot-select-4">
                        <option value="">Select a bot...</option>
                    </select>
                </div>
            </div>
            <button onclick="loadComparison()" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                Compare Bots
            </button>
        </div>

        <div id="comparison-results"></div>
    </div>

    <script>
        let allBots = [];

        async function loadBotsList() {
            try {
                const response = await fetch('/api/leaderboard?limit=100');
                const data = await response.json();
                allBots = data.rankings;

                // Populate all select boxes
                [1, 2, 3, 4].forEach(i => {
                    const select = document.getElementById(`bot-select-${i}`);
                    data.rankings.forEach(bot => {
                        const option = document.createElement('option');
                        option.value = bot.bot_id;
                        option.textContent = `#${bot.rank} ${bot.bot_name}`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Failed to load bots:', error);
            }
        }

        async function loadComparison() {
            const selectedBots = [];
            [1, 2, 3, 4].forEach(i => {
                const select = document.getElementById(`bot-select-${i}`);
                if (select.value) {
                    const bot = allBots.find(b => b.bot_id === select.value);
                    if (bot) selectedBots.push(bot);
                }
            });

            if (selectedBots.length < 2) {
                alert('Please select at least 2 bots to compare');
                return;
            }

            const resultsDiv = document.getElementById('comparison-results');
            resultsDiv.innerHTML = '<div class="card mt-24"><p style="text-align: center; color: var(--muted);">Loading comparison...</p></div>';

            try {
                // Fetch detailed data for each bot
                const botDetails = await Promise.all(
                    selectedBots.map(bot => fetch(`/api/bots/${bot.bot_id}?limit=50`).then(r => r.json()))
                );

                renderComparison(selectedBots, botDetails);
            } catch (error) {
                console.error('Failed to load comparison:', error);
                resultsDiv.innerHTML = '<div class="card mt-24"><p style="text-align: center; color: var(--negative);">Failed to load comparison data</p></div>';
            }
        }

        function renderComparison(bots, details) {
            const resultsDiv = document.getElementById('comparison-results');

            let html = '<div class="comparison-grid">';

            bots.forEach((bot, index) => {
                const detail = details[index];
                const portfolio = detail.portfolio || {};
                const pnlClass = bot.pnl >= 0 ? 'positive' : 'negative';

                html += `
                    <div class="bot-comparison-card" style="border-color: ${getColorForIndex(index)};">
                        <h3>
                            <a href="/bot.html?id=${bot.bot_id}" style="color: inherit; text-decoration: none;">
                                #${bot.rank} ${escapeHtml(bot.bot_name)}
                            </a>
                        </h3>
                        <div class="stat-row">
                            <span class="stat-label">Portfolio Value</span>
                            <span class="stat-value">$${bot.total_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">P&L</span>
                            <span class="stat-value ${pnlClass}">${bot.pnl >= 0 ? '+' : ''}$${bot.pnl.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Return %</span>
                            <span class="stat-value ${pnlClass}">${bot.pnl_percent >= 0 ? '+' : ''}${bot.pnl_percent.toFixed(2)}%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Trades</span>
                            <span class="stat-value">${bot.trade_count}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Positions</span>
                            <span class="stat-value">${portfolio.positions ? portfolio.positions.length : 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Cash Balance</span>
                            <span class="stat-value">$${portfolio.cash_balance ? portfolio.cash_balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Add common symbols section
            html += '<div class="card mt-24"><h3>Common Positions</h3>';
            const commonSymbols = findCommonSymbols(details);
            if (commonSymbols.length > 0) {
                html += '<table><thead><tr><th>Symbol</th>';
                bots.forEach(bot => {
                    html += `<th>${escapeHtml(bot.bot_name)}</th>`;
                });
                html += '</tr></thead><tbody>';

                commonSymbols.forEach(symbol => {
                    html += `<tr><td><a href="/chart.html?symbol=${symbol}">${symbol}</a></td>`;
                    details.forEach(detail => {
                        const position = detail.portfolio?.positions?.find(p => p.symbol === symbol);
                        if (position) {
                            html += `<td>${position.quantity} @ $${position.avg_cost.toFixed(2)}</td>`;
                        } else {
                            html += '<td style="color: var(--muted);">-</td>';
                        }
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
            } else {
                html += '<p style="color: var(--muted); text-align: center; padding: 20px;">No common positions found</p>';
            }
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        function findCommonSymbols(details) {
            const symbolSets = details.map(d =>
                new Set((d.portfolio?.positions || []).map(p => p.symbol))
            );

            if (symbolSets.length === 0) return [];

            // Find symbols that appear in at least 2 bots
            const allSymbols = new Set();
            symbolSets.forEach(set => {
                set.forEach(symbol => allSymbols.add(symbol));
            });

            const common = [];
            allSymbols.forEach(symbol => {
                const count = symbolSets.filter(set => set.has(symbol)).length;
                if (count >= 2) {
                    common.push(symbol);
                }
            });

            return common.sort();
        }

        function getColorForIndex(index) {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            return colors[index % colors.length];
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load bots list on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadBotsList);
        } else {
            loadBotsList();
        }
    </script>
</body>
</html>
